name: Publish to GitHub Packages
on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      # 1. 安装 pnpm（和本地一致）
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.20.0

      # 2. 配置 Node.js（和本地一致的 24.x 版本）
      - name: Setup Node.js 24.x
        uses: actions/setup-node@v4
        with:
          node-version: 24.11.0
          # 关键：禁用 setup-node 自动注入的 Token
          registry-url: ""

      # 3. 安装依赖（和本地一致）
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 4. 构建（修复 TS 参数，和本地一致）
      - name: Build
        run: |
          # 修复 tsc --verbose 错误（和本地执行的命令一致）
          sed -i 's/tsc --verbose/tsc/g' package.json
          pnpm run build || tsc

      # 5. 复刻本地 npm login 认证（核心！）
      - name: Login to GitHub Packages
        run: |
          # 完全复刻本地 npm login 生成的 .npmrc 内容
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          echo "@wangchen2021:registry=https://npm.pkg.github.com" >> ~/.npmrc
          echo "always-auth=true" >> ~/.npmrc
          
          # 验证认证（和本地执行 npm whoami 一致）
          npm whoami --registry=https://npm.pkg.github.com

      # 6. 发布（和本地执行 npm publish/pnpm publish 一致）
      - name: Publish package
        run: pnpm publish --access public --tag latest
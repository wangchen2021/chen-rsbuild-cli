name: Enterprise NPM Publish
run-name: ${{ github.actor }} å‘å¸ƒåŒ… ğŸš€ [${{ github.ref_name }}]

on:
  release:
    types: [published]  # Release æ­£å¼å‘å¸ƒåè§¦å‘
  workflow_dispatch:    # æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºç´§æ€¥å‘å¸ƒ/æµ‹è¯•ï¼‰
    inputs:
      deploy_env:
        description: 'å‘å¸ƒç¯å¢ƒæ ‡è¯†'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      custom_tag:
        description: 'è‡ªå®šä¹‰ npm æ ‡ç­¾ï¼ˆé»˜è®¤ betaï¼Œæ­£å¼ç‰ˆå¡« latestï¼‰'
        required: false
        default: 'beta'

# ä¼ä¸šçº§ç¯å¢ƒé…ç½®ï¼ˆé›†ä¸­ç®¡ç†ï¼Œä¾¿äºç»´æŠ¤ï¼‰
env:
  NODE_VERSION: '20.18.0'          # é”å®š LTS ç‰ˆæœ¬ï¼Œé¿å…å…¼å®¹æ€§é—®é¢˜
  PNPM_VERSION: '10.20.0'          # ä¸æœ¬åœ°/CI ç¯å¢ƒä¸€è‡´çš„ pnpm ç‰ˆæœ¬
  NPM_REGISTRY: 'https://npm.pkg.github.com'  # GitHub Packages åœ°å€
  NPM_SCOPE: '@wangchen2021'       # ä¼ä¸šçº§ä½œç”¨åŸŸï¼ˆGitHub ç”¨æˆ·å/ç»„ç»‡åï¼‰
  PACKAGE_JSON_PATH: './package.json'  # åŒ…é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆä¾¿äºå¤šåŒ…ç®¡ç†ï¼‰

jobs:
  publish-package:
    runs-on: ubuntu-latest
    # ä¼ä¸šçº§æƒé™æœ€å°åŒ–åŸåˆ™ï¼šä»…æˆäºˆå¿…è¦æƒé™
    permissions:
      packages: write               # å‘å¸ƒ/ç®¡ç† GitHub Packages
      contents: read                # è¯»å–ä»“åº“ä»£ç 
      id-token: write               # å¯é€‰ï¼šç”¨äº OIDC è®¤è¯ï¼ˆæ›¿ä»£é™æ€ä»¤ç‰Œï¼‰
    # çŸ©é˜µæµ‹è¯•ï¼ˆå¯é€‰ï¼šä¼ä¸šçº§å¤šç¯å¢ƒéªŒè¯ï¼Œå¯æ³¨é‡Šï¼‰
    # strategy:
    #   matrix:
    #     node-version: [20.18.0]
    #   fail-fast: false  # ä¸€ä¸ªç¯å¢ƒå¤±è´¥ä¸ç»ˆæ­¢å…¶ä»–ç¯å¢ƒ

    steps:
      # 1. æ‹‰å–ä»£ç ï¼ˆå«å®Œæ•´æäº¤è®°å½•ï¼Œç”¨äºç‰ˆæœ¬å®¡è®¡ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false  # é¿å…æƒé™å†²çª

      # 2. ç¯å¢ƒé¢„æ£€ï¼ˆä¼ä¸šçº§åˆè§„è¦æ±‚ï¼‰
      - name: Environment pre-check
        run: |
          echo "ğŸ” æ‰§è¡Œç¯å¢ƒé¢„æ£€..."
          # æ£€æŸ¥æ ¸å¿ƒæ–‡ä»¶å­˜åœ¨æ€§
          if [ ! -f "${{ env.PACKAGE_JSON_PATH }}" ]; then
            echo "âŒ æ ¸å¿ƒæ–‡ä»¶ç¼ºå¤±ï¼š${{ env.PACKAGE_JSON_PATH }}"
            exit 1
          fi
          # æ£€æŸ¥ Git çŠ¶æ€ï¼ˆé¿å…è„å·¥ä½œåŒºï¼‰
          if [ -n "$(git status --porcelain)" ]; then
            echo "âš  å·¥ä½œåŒºå­˜åœ¨æœªæäº¤ä¿®æ”¹ï¼Œè¯·æ³¨æ„å®¡è®¡"
            git status --porcelain
          fi

      # 3. é…ç½® Node.js ç¯å¢ƒï¼ˆä¼ä¸šçº§ç¼“å­˜ç­–ç•¥ï¼‰
      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'               # ç¼“å­˜ pnpm ä¾èµ–ï¼ŒåŠ é€Ÿæ„å»º
          cache-dependency-path: './pnpm-lock.yaml'
          registry-url: ${{ env.NPM_REGISTRY }}

      # 4. å®‰è£… pnpmï¼ˆé”å®šç‰ˆæœ¬ï¼Œé¿å…è‡ªåŠ¨å‡çº§ï¼‰
      - name: Install pnpm ${{ env.PNPM_VERSION }}
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      # 5. å®‰è£…ä¾èµ–ï¼ˆä¼ä¸šçº§ä¾èµ–é”å®šï¼‰
      - name: Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆé”å®šç‰ˆæœ¬ï¼‰..."
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile --prod=false
          else
            echo "âŒ ç¼ºå¤± pnpm-lock.yamlï¼Œä¼ä¸šçº§é¡¹ç›®å¿…é¡»é”å®šä¾èµ–ç‰ˆæœ¬"
            exit 1
          fi
          # ä¾èµ–å®Œæ•´æ€§æ ¡éªŒï¼ˆå¯é€‰ï¼šä¼ä¸šçº§å®‰å…¨è¦æ±‚ï¼‰
          pnpm audit --severity high || echo "âš  æ£€æµ‹åˆ°é«˜å±ä¾èµ–æ¼æ´ï¼Œè¯·åŠæ—¶ä¿®å¤"

      # 6. æ„å»ºé¡¹ç›®ï¼ˆä¼ä¸šçº§æ„å»ºè§„èŒƒï¼‰
      - name: Build project
        id: build
        run: |
          echo "ğŸ”¨ æ‰§è¡Œé¡¹ç›®æ„å»º..."
          if pnpm run build --help >/dev/null 2>&1; then
            pnpm run build --verbose
            # æ„å»ºäº§ç‰©æ ¡éªŒ
            if [ ! -d "dist" ]; then
              echo "âŒ æ„å»ºäº§ç‰©ç›®å½• dist ç¼ºå¤±"
              exit 1
            fi
            echo "âœ… æ„å»ºæˆåŠŸï¼Œäº§ç‰©å¤§å°ï¼š$(du -sh dist | awk '{print $1}')"
            echo "build_success=true" >> $GITHUB_OUTPUT
          else
            echo "âš  æ—  build è„šæœ¬ï¼Œè·³è¿‡æ„å»ºï¼ˆä¼ä¸šçº§é¡¹ç›®å»ºè®®æ·»åŠ æ ‡å‡†åŒ–æ„å»ºæµç¨‹ï¼‰"
            echo "build_success=false" >> $GITHUB_OUTPUT
          fi

      # 7. ç‰ˆæœ¬ä¸€è‡´æ€§æ ¡éªŒï¼ˆä¼ä¸šçº§å‘å¸ƒåˆè§„ï¼‰
      - name: Validate version consistency
        id: version_check
        run: |
          echo "ğŸ“Š æ ¡éªŒç‰ˆæœ¬ä¸€è‡´æ€§..."
          # æå– Release ç‰ˆæœ¬ï¼ˆå»é™¤ v å‰ç¼€ï¼‰
          RELEASE_VERSION="${{ github.ref_name }}"
          RELEASE_VERSION_CLEAN=${RELEASE_VERSION#v}
          # æå– package.json ç‰ˆæœ¬
          PACKAGE_VERSION=$(pnpm pkg get version --file "${{ env.PACKAGE_JSON_PATH }}" | tr -d '"')
          
          # ç‰ˆæœ¬ä¸€è‡´æ€§æ ¡éªŒ
          if [ "$RELEASE_VERSION_CLEAN" != "$PACKAGE_VERSION" ]; then
            echo "âŒ ç‰ˆæœ¬ä¸ä¸€è‡´ï¼šRelease($RELEASE_VERSION_CLEAN) â‰  Package($PACKAGE_VERSION)"
            exit 1
          fi
          echo "âœ… ç‰ˆæœ¬æ ¡éªŒé€šè¿‡ï¼š$PACKAGE_VERSION"
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT

      # 8. é…ç½® npm è®¤è¯ï¼ˆä¼ä¸šçº§å®‰å…¨è®¤è¯ï¼‰
      - name: Configure npm authentication
        run: |
          echo "ğŸ” é…ç½® npm è®¤è¯..."
          # ç”Ÿæˆå®‰å…¨çš„ .npmrcï¼ˆä»…å½“å‰ä¼šè¯æœ‰æ•ˆï¼‰
          cat > .npmrc << EOF
          //npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}
          ${{ env.NPM_SCOPE }}:registry=${{ env.NPM_REGISTRY }}
          always-auth=true
          cache=false
          EOF
          # è®¤è¯æœ‰æ•ˆæ€§æ ¡éªŒ
          npm whoami --registry="${{ env.NPM_REGISTRY }}" || {
            echo "âŒ npm è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ NPM_TOKEN æƒé™"
            exit 1
          }
          # å®¡è®¡ .npmrc é…ç½®ï¼ˆé¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼‰
          cat .npmrc | sed "s/_authToken=.*/_authToken=***REDACTED***/"

      # 9. å‘å¸ƒåŒ…ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼špnpm publishï¼‰
      - name: Publish package with pnpm
        id: publish
        run: |
          echo "ğŸš€ å¼€å§‹å‘å¸ƒåŒ…ï¼š${{ env.NPM_SCOPE }}/chen-rsbuild-cli@${{ steps.version_check.outputs.package_version }}"
          # ä¼ä¸šçº§å‘å¸ƒç­–ç•¥ï¼šæŒ‡å®šæ ‡ç­¾ï¼Œé¿å…è¦†ç›– latest
          CUSTOM_TAG="${{ github.event.inputs.custom_tag || 'beta' }}"
          # æ‰§è¡Œ pnpm publishï¼ˆå…¼å®¹ GitHub Packages æƒé™ï¼‰
          pnpm publish \
            --registry="${{ env.NPM_REGISTRY }}" \
            --tag="$CUSTOM_TAG" \
            --access restricted \
            --verbose 2>&1 || {
              echo "âŒ pnpm å‘å¸ƒå¤±è´¥ï¼Œé”™è¯¯æ—¥å¿—ï¼š"
              cat ~/.npm/_logs/*-debug.log 2>/dev/null
              exit 1
            }
          echo "âœ… åŒ…å‘å¸ƒæˆåŠŸï¼Œæ ‡ç­¾ï¼š$CUSTOM_TAG"
          echo "publish_tag=$CUSTOM_TAG" >> $GITHUB_OUTPUT

      # 10. å‘å¸ƒåå®¡è®¡ï¼ˆä¼ä¸šçº§åˆè§„ï¼‰
      - name: Post-publish audit
        if: always()
        run: |
          echo "ğŸ“‹ å‘å¸ƒå®¡è®¡æŠ¥å‘Š..."
          echo "========================================"
          echo "ä¼ä¸šçº§å‘å¸ƒå®¡è®¡ä¿¡æ¯ï¼š"
          echo "å‘å¸ƒæ—¶é—´ï¼š$(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S')"
          echo "å‘å¸ƒäººï¼š${{ github.actor }}"
          echo "åŒ…åï¼š$(pnpm pkg get name --file "${{ env.PACKAGE_JSON_PATH }}" | tr -d '"')"
          echo "ç‰ˆæœ¬ï¼š${{ steps.version_check.outputs.package_version }}"
          echo "å‘å¸ƒä»“åº“ï¼š${{ env.NPM_REGISTRY }}"
          echo "å‘å¸ƒæ ‡ç­¾ï¼š${{ steps.publish.outputs.publish_tag }}"
          echo "æ„å»ºçŠ¶æ€ï¼š${{ steps.build.outputs.build_success }}"
          echo "GitHub Releaseï¼šhttps://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          echo "========================================"

      # 11. å¤±è´¥é€šçŸ¥ï¼ˆå¯é€‰ï¼šä¼ä¸šçº§å‘Šè­¦ï¼Œå¯å¯¹æ¥ Slack/é‚®ä»¶ï¼‰
      - name: Send failure notification
        if: failure()
        run: |
          echo "ğŸš¨ åŒ…å‘å¸ƒå¤±è´¥ï¼Œè¯·åŠæ—¶å¤„ç†ï¼"
          # ä¼ä¸šçº§æ‰©å±•ï¼šæ·»åŠ  Slack/é’‰é’‰/é‚®ä»¶å‘Šè­¦é€»è¾‘
          # curl -X POST -H "Content-Type: application/json" -d '{"text":"å‘å¸ƒå¤±è´¥ï¼š${{ github.repository }}@${{ steps.version_check.outputs.package_version }}"}' ${{ secrets.SLACK_WEBHOOK }}
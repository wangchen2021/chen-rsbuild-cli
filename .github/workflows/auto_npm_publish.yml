name: NPM Publish - Auto Release
run-name: ${{ github.actor }} å‘å¸ƒ NPM åŒ… ðŸš€ [${{ github.ref_name }}]

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      deploy_env:
        description: 'å‘å¸ƒçŽ¯å¢ƒï¼ˆä»…ç”¨äºŽæ ‡è¯†ï¼‰'
        required: true
        default: 'production'
        type: choice
        options:
          - production

env:
  # é™çº§ä¸ºLTSç‰ˆæœ¬ï¼Œè§£å†³24.xå…¼å®¹æ€§é—®é¢˜
  NODE_VERSION: '20.18.0'
  PNPM_VERSION: '10.20.0'
  # å‘å¸ƒä»“åº“ï¼ˆé™æ€å€¼ï¼‰
  NPM_REGISTRY: 'https://npm.pkg.github.com'

jobs:
  publish-npm-package:
    runs-on: ubuntu-latest
    # å…¨å±€é”™è¯¯æ•èŽ·
    env:
      SHELLOPTS: errexit:pipefail
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install base dependencies
        run: |
          sudo apt-get update -y && sudo apt-get install -y --no-install-recommends tar curl jq gh
          tar --version && curl --version && jq --version && gh --version

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: ${{ env.NPM_REGISTRY }}

      - name: åˆå§‹åŒ–åŠ¨æ€é…ç½®ï¼ˆä¿®å¤è¡¨è¾¾å¼/å…¼å®¹æ€§é—®é¢˜ï¼‰
        id: dynamic_config
        run: |
          set -euo pipefail
          # 1. ä»ŽGitHubä¸Šä¸‹æ–‡èŽ·å–ç”¨æˆ·å/ä»“åº“å
          NPM_SCOPE="${{ github.repository_owner }}"
          PACKAGE_NAME_BASE="${{ github.event.repository.name }}"
          
          # 2. å…¼å®¹èŽ·å–package.jsonåŒ…å
          if [ -f "package.json" ]; then
            PACKAGE_NAME_FROM_JSON=$(jq -r '.name' package.json)
            if [ "$PACKAGE_NAME_FROM_JSON" = "null" ] || [ -z "$PACKAGE_NAME_FROM_JSON" ]; then
              PACKAGE_NAME_FROM_JSON="@${NPM_SCOPE}/${PACKAGE_NAME_BASE}"
            fi
          else
            PACKAGE_NAME_FROM_JSON="@${NPM_SCOPE}/${PACKAGE_NAME_BASE}"
          fi
          
          # 3. æå–ä½œç”¨åŸŸ
          if echo "$PACKAGE_NAME_FROM_JSON" | grep -q '/'; then
            NPM_SCOPE_CLEAN=$(echo "$PACKAGE_NAME_FROM_JSON" | cut -d'/' -f1 | sed 's/^@//')
          else
            NPM_SCOPE_CLEAN="$NPM_SCOPE"
          fi
          
          # 4. è¾“å‡ºåˆ°GitHubä¸Šä¸‹æ–‡
          echo "PACKAGE_NAME=$PACKAGE_NAME_FROM_JSON" >> $GITHUB_OUTPUT
          echo "NPM_SCOPE=$NPM_SCOPE_CLEAN" >> $GITHUB_OUTPUT
          echo "PACKAGE_NAME_BASE=$PACKAGE_NAME_BASE" >> $GITHUB_OUTPUT
          
          # éªŒè¯è¾“å‡º
          echo "âœ… åŠ¨æ€é…ç½®åˆå§‹åŒ–å®Œæˆï¼š"
          echo "åŒ…åï¼š$PACKAGE_NAME_FROM_JSON"
          echo "ä½œç”¨åŸŸï¼š$NPM_SCOPE_CLEAN"
          echo "ä»“åº“åï¼š$PACKAGE_NAME_BASE"

      - name: éªŒè¯Releaseç‰ˆæœ¬ä¸Žpackage.jsonä¸€è‡´
        id: version_check
        run: |
          set -euo pipefail
          # èŽ·å–Releaseæ ‡ç­¾ç‰ˆæœ¬ï¼ˆåŽ»æŽ‰vå‰ç¼€ï¼‰
          RELEASE_VERSION="${{ github.ref_name }}"
          RELEASE_VERSION=${RELEASE_VERSION#v}
          
          # å…¼å®¹èŽ·å–package.jsonç‰ˆæœ¬
          if [ -f "package.json" ]; then
            PACKAGE_VERSION=$(jq -r '.version' package.json)
            if [ "$PACKAGE_VERSION" = "null" ] || [ -z "$PACKAGE_VERSION" ]; then
              echo "âŒ package.jsonä¸­æœªé…ç½®versionå­—æ®µï¼"
              exit 1
            fi
          else
            echo "âŒ æœªæ‰¾åˆ°package.jsonæ–‡ä»¶ï¼"
            exit 1
          fi
          
          # ç‰ˆæœ¬æ ¡éªŒ
          if [ "$RELEASE_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "âŒ Releaseç‰ˆæœ¬ï¼ˆ$RELEASE_VERSIONï¼‰ä¸Žpackage.jsonç‰ˆæœ¬ï¼ˆ$PACKAGE_VERSIONï¼‰ä¸ä¸€è‡´ï¼"
            exit 1
          fi
          
          echo "âœ… ç‰ˆæœ¬æ ¡éªŒé€šè¿‡ï¼š$RELEASE_VERSION"
          echo "PACKAGE_VERSION=$RELEASE_VERSION" >> $GITHUB_OUTPUT

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        run: |
          set -euo pipefail
          # æ£€æŸ¥lockæ–‡ä»¶
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile --prod=false
          else
            pnpm install --prod=false
          fi
          
          # å¯é€‰ï¼šæ‰§è¡Œæž„å»º
          if pnpm run build --help >/dev/null 2>&1; then
            pnpm run build
            # éªŒè¯æž„å»ºäº§ç‰©
            if [ -d "dist" ]; then
              echo "âœ… æž„å»ºäº§ç‰©distç›®å½•å­˜åœ¨"
              ls -la dist/
            fi
          elif pnpm run compile --help >/dev/null 2>&1; then
            pnpm run compile
          else
            echo "âš  æ— build/compileè„šæœ¬ï¼Œè·³è¿‡æž„å»º"
          fi

      - name: é…ç½®npmè®¤è¯ï¼ˆåŠ¨æ€ä½œç”¨åŸŸï¼‰
        run: |
          set -euo pipefail
          # æ£€æŸ¥NPM_TOKENæ˜¯å¦é…ç½®
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "âŒ æœªé…ç½®NPM_TOKENå¯†é’¥ï¼"
            exit 1
          fi
          
          # å¤„ç†registryåœ°å€
          NPM_REGISTRY_NO_PROTOCOL="${{ env.NPM_REGISTRY }}"
          NPM_REGISTRY_NO_PROTOCOL=${NPM_REGISTRY_NO_PROTOCOL#https://}
          
          # ç”Ÿæˆ.npmrc
          echo "//${NPM_REGISTRY_NO_PROTOCOL}/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc
          echo "@${{ steps.dynamic_config.outputs.NPM_SCOPE }}:registry=${{ env.NPM_REGISTRY }}" >> .npmrc
          echo "cache=false" >> .npmrc
          echo "always-auth=true" >> .npmrc # å¼ºåˆ¶è®¤è¯ï¼Œé¿å…è·³è¿‡
          
          # éªŒè¯é…ç½®
          echo "ðŸ“„ ç”Ÿæˆçš„.npmrcé…ç½®ï¼š"
          cat .npmrc
          # éªŒè¯npmé…ç½®
          npm config list

      - name: å‘å¸ƒNPMåŒ…ï¼ˆå¸¦è¯¦ç»†æ—¥å¿—ï¼‰
        run: |
          set -euo pipefail
          # å‘å¸ƒå‰æ£€æŸ¥æ‰€æœ‰ä¿¡æ¯
          echo "ðŸ“¤ å‘å¸ƒå‰æœ€ç»ˆæ£€æŸ¥ï¼š"
          echo "åŒ…åï¼š${{ steps.dynamic_config.outputs.PACKAGE_NAME }}"
          echo "ç‰ˆæœ¬ï¼š${{ steps.version_check.outputs.PACKAGE_VERSION }}"
          echo "npmä»“åº“ï¼š${{ env.NPM_REGISTRY }}"
          echo "å½“å‰ç›®å½•ï¼š$(pwd)"
          echo "package.jsonå†…å®¹ï¼š"
          cat package.json
          echo "npmç‰ˆæœ¬ï¼š$(npm -v)"
          echo "nodeç‰ˆæœ¬ï¼š$(node -v)"
          
          # æ‰§è¡Œå‘å¸ƒï¼ˆå¸¦è¯¦ç»†æ—¥å¿—ï¼‰
          echo "ðŸš€ å¼€å§‹å‘å¸ƒNPMåŒ…..."
          if [ "${{ env.NPM_REGISTRY }}" = "https://registry.npmjs.org" ]; then
            npm publish --access public --verbose
          else
            # GitHub Packageså‘å¸ƒ
            npm publish --userconfig .npmrc --verbose
          fi
          
          # éªŒè¯å‘å¸ƒç»“æžœ
          echo "âœ… NPMåŒ…å‘å¸ƒæˆåŠŸï¼"
          echo "åŒ…åï¼š${{ steps.dynamic_config.outputs.PACKAGE_NAME }}"
          echo "ç‰ˆæœ¬ï¼š${{ steps.version_check.outputs.PACKAGE_VERSION }}"
          
          # å°è¯•ç”¨GitHub APIéªŒè¯
          if [ "${{ env.NPM_REGISTRY }}" = "https://npm.pkg.github.com" ]; then
            echo "ðŸ” å°è¯•é€šè¿‡GitHub APIéªŒè¯å‘å¸ƒ..."
            gh auth setup-git
            gh api --silent "/users/${{ steps.dynamic_config.outputs.NPM_SCOPE }}/packages/npm/${{ steps.dynamic_config.outputs.PACKAGE_NAME_BASE }}/versions/${{ steps.version_check.outputs.PACKAGE_VERSION }}" && echo "âœ… GitHub APIéªŒè¯å‘å¸ƒæˆåŠŸ" || echo "â„¹ GitHub APIéªŒè¯è·³è¿‡ï¼ˆå¯èƒ½æƒé™ä¸è¶³ï¼‰"
          else
            npm view "${{ steps.dynamic_config.outputs.PACKAGE_NAME }}" version || echo "â„¹ npmå®˜æ–¹éªŒè¯è·³è¿‡"
          fi

      - name: è¾“å‡ºå‘å¸ƒä¿¡æ¯
        if: always()
        run: |
          echo "ðŸ“¦ æœ€ç»ˆå‘å¸ƒä¿¡æ¯æ±‡æ€»ï¼š"
          echo "========================================"
          echo "åŒ…åï¼š${{ steps.dynamic_config.outputs.PACKAGE_NAME }}"
          echo "ç‰ˆæœ¬ï¼š${{ steps.version_check.outputs.PACKAGE_VERSION }}"
          echo "å‘å¸ƒä»“åº“ï¼š${{ env.NPM_REGISTRY }}"
          echo "ä½œç”¨åŸŸï¼š@${{ steps.dynamic_config.outputs.NPM_SCOPE }}"
          echo "Releaseæ ‡ç­¾ï¼š${{ github.ref_name }}"
          echo "æž„å»ºæ—¶é—´ï¼š$(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S')"
          echo "æ‰§è¡ŒçŠ¶æ€ï¼š${{ job.status }}"
          echo "========================================"
          # è¾“å‡ºå…³é”®æ—¥å¿—æ–¹ä¾¿æŽ’æŸ¥
          if [ "${{ job.status }}" = "failure" ]; then
            echo "âŒ å‘å¸ƒå¤±è´¥ï¼Œè¡¥å……å…³é”®ä¿¡æ¯ï¼š"
            echo "NPM_TOKENé…ç½®çŠ¶æ€ï¼š${{ secrets.NPM_TOKEN != '' && 'å·²é…ç½®' || 'æœªé…ç½®' }}"
            echo ".npmrcæ–‡ä»¶å†…å®¹ï¼š"
            cat .npmrc || echo "æ— .npmrcæ–‡ä»¶"
            echo "npmé”™è¯¯æ—¥å¿—ï¼š"
            cat ~/.npm/_logs/*-debug.log 2>/dev/null || echo "æ— npmé”™è¯¯æ—¥å¿—"
          fi
name: Enterprise NPM Publish
run-name: ${{ github.actor }} å‘å¸ƒåŒ… ğŸš€ [${{ github.ref_name }}]

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      deploy_env:
        description: 'å‘å¸ƒç¯å¢ƒæ ‡è¯†'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - development
      custom_tag:
        description: 'è‡ªå®šä¹‰ npm æ ‡ç­¾ï¼ˆé»˜è®¤ latest æµ‹è¯•ç‰ˆå¡« betaï¼‰'
        required: false
        default: 'latest'

env:
  NODE_VERSION: '24.11.0'          
  PNPM_VERSION: '10.20.0'          
  NPM_REGISTRY: 'https://npm.pkg.github.com'
  NPM_SCOPE: '@wangchen2021'
  PACKAGE_JSON_PATH: './package.json'
  PNPM_HOME: '/home/runner/.local/share/pnpm'

jobs:
  publish-package:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Environment pre-check
        run: |
          echo "ğŸ” æ‰§è¡Œç¯å¢ƒé¢„æ£€..."
          if [ ! -f "${{ env.PACKAGE_JSON_PATH }}" ]; then
            echo "âŒ æ ¸å¿ƒæ–‡ä»¶ç¼ºå¤±ï¼š${{ env.PACKAGE_JSON_PATH }}"
            exit 1
          fi
          if [ -n "$(git status --porcelain)" ]; then
            echo "âš  å·¥ä½œåŒºå­˜åœ¨æœªæäº¤ä¿®æ”¹ï¼Œè¯·æ³¨æ„å®¡è®¡"
            git status --porcelain
          fi

      - name: Install pnpm ${{ env.PNPM_VERSION }}
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false
        env:
          PNPM_HOME: ${{ env.PNPM_HOME }}

      - name: Add pnpm to PATH
        run: |
          echo "${{ env.PNPM_HOME }}" >> $GITHUB_PATH
          echo "PNPM_HOME=${{ env.PNPM_HOME }}" >> $GITHUB_ENV
          pnpm --version || {
            echo "âŒ pnpm å®‰è£…å¤±è´¥ï¼Œè·¯å¾„ï¼š${{ env.PNPM_HOME }}"
            exit 1
          }

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: './pnpm-lock.yaml'
          registry-url: ${{ env.NPM_REGISTRY }}

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆé”å®šç‰ˆæœ¬ï¼‰..."
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile --prod=false --config.ignore-engines=true
          else
            echo "âŒ ç¼ºå¤± pnpm-lock.yamlï¼Œä¼ä¸šçº§é¡¹ç›®å¿…é¡»é”å®šä¾èµ–ç‰ˆæœ¬"
            exit 1
          fi
          pnpm audit --severity high || echo "âš  æ£€æµ‹åˆ°é«˜å±ä¾èµ–æ¼æ´ï¼Œè¯·åŠæ—¶ä¿®å¤"

      - name: Build project
        id: build
        run: |
          echo "ğŸ”¨ æ‰§è¡Œé¡¹ç›®æ„å»ºï¼ˆä¿®å¤ TS ç¼–è¯‘å‚æ•°ï¼‰..."
          if [ -f "package.json" ]; then
            sed -i 's/tsc --verbose/tsc/g' package.json
            echo "âœ… ä¿®å¤åçš„ build è„šæœ¬ï¼š$(pnpm pkg get scripts.build | tr -d '"')"
          fi

          if pnpm run build --help >/dev/null 2>&1; then
            pnpm run build --verbose 2>&1 || {
              echo "âŒ æ„å»ºå¤±è´¥ï¼Œå°è¯•ç›´æ¥æ‰§è¡Œ tsc"
              tsc
            }
            if [ ! -d "dist" ]; then
              echo "âŒ æ„å»ºäº§ç‰©ç›®å½• dist ç¼ºå¤±"
              exit 1
            fi
            echo "âœ… æ„å»ºæˆåŠŸï¼Œäº§ç‰©å¤§å°ï¼š$(du -sh dist | awk '{print $1}')"
            echo "build_success=true" >> $GITHUB_OUTPUT
          else
            echo "âš  æ—  build è„šæœ¬ï¼Œè·³è¿‡æ„å»º"
            echo "build_success=false" >> $GITHUB_OUTPUT
          fi

      # æ ¸å¿ƒä¿®å¤ï¼šç‰ˆæœ¬è§£æï¼ˆç”¨ node æ›¿ä»£ pnpm pkg getï¼Œé¿å…æ ¼å¼å¼‚å¸¸ï¼‰
      - name: Validate version consistency
        id: version_check
        run: |
          echo "ğŸ“Š æ ¡éªŒç‰ˆæœ¬ä¸€è‡´æ€§..."
          # æå– Release ç‰ˆæœ¬ï¼ˆå»é™¤ v å‰ç¼€ï¼‰
          RELEASE_VERSION="${{ github.ref_name }}"
          RELEASE_VERSION_CLEAN=${RELEASE_VERSION#v}
          
          # æ ¸å¿ƒä¿®å¤ï¼šç”¨ node å‘½ä»¤è§£æ package.jsonï¼Œä¿è¯è¿”å›çº¯ç‰ˆæœ¬å·
          PACKAGE_VERSION=$(node -p "require('${{ env.PACKAGE_JSON_PATH }}').version")
          # å…œåº•å¤„ç†ï¼šé¿å…ç‰ˆæœ¬ä¸ºç©º
          PACKAGE_VERSION=${PACKAGE_VERSION:-"0.0.0"}
          
          # æ‰“å°åŸå§‹å€¼ç”¨äºè°ƒè¯•
          echo "ğŸ“ ç‰ˆæœ¬å¯¹æ¯”ï¼š"
          echo "Release ç‰ˆæœ¬ï¼ˆæ¸…ç†åï¼‰ï¼š$RELEASE_VERSION_CLEAN"
          echo "Package.json ç‰ˆæœ¬ï¼š$PACKAGE_VERSION"
          
          # ä¸¥æ ¼æ¯”å¯¹ç‰ˆæœ¬
          if [ "$RELEASE_VERSION_CLEAN" != "$PACKAGE_VERSION" ]; then
            echo "âŒ ç‰ˆæœ¬ä¸ä¸€è‡´ï¼šRelease($RELEASE_VERSION_CLEAN) â‰  Package($PACKAGE_VERSION)"
            exit 1
          fi
          
          echo "âœ… ç‰ˆæœ¬æ ¡éªŒé€šè¿‡ï¼š$PACKAGE_VERSION"
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT

      - name: Configure npm authentication
        run: |
          echo "ğŸ” é…ç½® npm è®¤è¯..."
          cat > .npmrc << EOF
          //npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}
          ${{ env.NPM_SCOPE }}:registry=${{ env.NPM_REGISTRY }}
          always-auth=true
          cache=false
          EOF
          npm whoami --registry="${{ env.NPM_REGISTRY }}" || {
            echo "âŒ npm è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ NPM_TOKEN æƒé™"
            exit 1
          }
          cat .npmrc | sed "s/_authToken=.*/_authToken=***REDACTED***/"

      - name: Publish package with pnpm
        id: publish
        run: |
          echo "ğŸš€ å¼€å§‹å‘å¸ƒåŒ…ï¼š${{ env.NPM_SCOPE }}/chen-rsbuild-cli@${{ steps.version_check.outputs.package_version }}"
          CUSTOM_TAG="${{ github.event.inputs.custom_tag || 'beta' }}"
          pnpm publish \
            --registry="${{ env.NPM_REGISTRY }}" \
            --tag="$CUSTOM_TAG" \
            --access restricted \
            --config.ignore-engines=true \
            --verbose 2>&1 || {
              echo "âŒ pnpm å‘å¸ƒå¤±è´¥ï¼Œé”™è¯¯æ—¥å¿—ï¼š"
              cat ~/.npm/_logs/*-debug.log 2>/dev/null
              exit 1
            }
          echo "âœ… åŒ…å‘å¸ƒæˆåŠŸï¼Œæ ‡ç­¾ï¼š$CUSTOM_TAG"
          echo "publish_tag=$CUSTOM_TAG" >> $GITHUB_OUTPUT

      - name: Post-publish audit
        if: always()
        run: |
          echo "ğŸ“‹ å‘å¸ƒå®¡è®¡æŠ¥å‘Š..."
          echo "========================================"
          echo "ä¼ä¸šçº§å‘å¸ƒå®¡è®¡ä¿¡æ¯ï¼š"
          echo "å‘å¸ƒæ—¶é—´ï¼š$(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S')"
          echo "å‘å¸ƒäººï¼š${{ github.actor }}"
          echo "åŒ…åï¼š$(node -p "require('${{ env.PACKAGE_JSON_PATH }}').name")"
          echo "ç‰ˆæœ¬ï¼š${{ steps.version_check.outputs.package_version }}"
          echo "å‘å¸ƒä»“åº“ï¼š${{ env.NPM_REGISTRY }}"
          echo "å‘å¸ƒæ ‡ç­¾ï¼š${{ steps.publish.outputs.publish_tag }}"
          echo "æ„å»ºçŠ¶æ€ï¼š${{ steps.build.outputs.build_success }}"
          echo "Node ç‰ˆæœ¬ï¼š$(node -v)"
          echo "pnpm ç‰ˆæœ¬ï¼š$(pnpm --version)"
          echo "GitHub Releaseï¼šhttps://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          echo "========================================"

      - name: Send failure notification
        if: failure()
        run: |
          echo "ğŸš¨ åŒ…å‘å¸ƒå¤±è´¥ï¼Œè¯·åŠæ—¶å¤„ç†ï¼"
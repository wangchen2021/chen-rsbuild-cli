name: NPM Publish - Auto Release
run-name: ${{ github.actor }} å‘å¸ƒ NPM åŒ… ğŸš€ [${{ github.ref_name }}]

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      deploy_env:
        description: 'å‘å¸ƒç¯å¢ƒï¼ˆä»…ç”¨äºæ ‡è¯†ï¼‰'
        required: true
        default: 'production'
        type: choice
        options:
          - production

env:
  NODE_VERSION: '20.18.0'
  PNPM_VERSION: '10.20.0'
  NPM_REGISTRY: 'https://npm.pkg.github.com'

jobs:
  publish-npm-package:
    runs-on: ubuntu-latest
    env:
      SHELLOPTS: errexit # ä¸´æ—¶å…³é—­ pipefailï¼Œé¿å…éå…³é”®å‘½ä»¤ç»ˆæ­¢
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install base dependencies
        run: |
          sudo apt-get update -y && sudo apt-get install -y --no-install-recommends tar curl jq gh
          tar --version && curl --version && jq --version && gh --version || true

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: ${{ env.NPM_REGISTRY }}

      - name: åˆå§‹åŒ–åŠ¨æ€é…ç½®
        id: dynamic_config
        run: |
          set -eu # ä»…å¼€å¯ errexitï¼Œå…³é—­ pipefail
          NPM_SCOPE="${{ github.repository_owner }}"
          PACKAGE_NAME_BASE="${{ github.event.repository.name }}"
          
          # å…œåº•ï¼šé¿å…å˜é‡ä¸ºç©º
          NPM_SCOPE=${NPM_SCOPE:-"wangchen2021"}
          PACKAGE_NAME_BASE=${PACKAGE_NAME_BASE:-"chen-rsbuild-cli"}
          
          if [ -f "package.json" ]; then
            PACKAGE_NAME_FROM_JSON=$(jq -r '.name' package.json || echo "@${NPM_SCOPE}/${PACKAGE_NAME_BASE}")
            if [ "$PACKAGE_NAME_FROM_JSON" = "null" ] || [ -z "$PACKAGE_NAME_FROM_JSON" ]; then
              PACKAGE_NAME_FROM_JSON="@${NPM_SCOPE}/${PACKAGE_NAME_BASE}"
            fi
          else
            PACKAGE_NAME_FROM_JSON="@${NPM_SCOPE}/${PACKAGE_NAME_BASE}"
          fi
          
          if echo "$PACKAGE_NAME_FROM_JSON" | grep -q '/'; then
            NPM_SCOPE_CLEAN=$(echo "$PACKAGE_NAME_FROM_JSON" | cut -d'/' -f1 | sed 's/^@//')
          else
            NPM_SCOPE_CLEAN="$NPM_SCOPE"
          fi
          
          echo "PACKAGE_NAME=$PACKAGE_NAME_FROM_JSON" >> $GITHUB_OUTPUT
          echo "NPM_SCOPE=$NPM_SCOPE_CLEAN" >> $GITHUB_OUTPUT
          echo "PACKAGE_NAME_BASE=$PACKAGE_NAME_BASE" >> $GITHUB_OUTPUT
          
          echo "âœ… åŠ¨æ€é…ç½®ï¼šåŒ…å=$PACKAGE_NAME_FROM_JSONï¼Œä½œç”¨åŸŸ=$NPM_SCOPE_CLEAN"

      - name: éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§
        id: version_check
        run: |
          set -eu
          RELEASE_VERSION="${{ github.ref_name }}"
          RELEASE_VERSION=${RELEASE_VERSION#v}
          RELEASE_VERSION=${RELEASE_VERSION:-"0.0.0"} # å…œåº•
          
          if [ -f "package.json" ]; then
            PACKAGE_VERSION=$(jq -r '.version' package.json || echo "0.0.0")
            if [ "$PACKAGE_VERSION" = "null" ] || [ -z "$PACKAGE_VERSION" ]; then
              echo "âŒ package.json version ä¸ºç©ºï¼"
              exit 1
            fi
          else
            echo "âŒ æ—  package.jsonï¼"
            exit 1
          fi
          
          if [ "$RELEASE_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "âŒ ç‰ˆæœ¬ä¸ä¸€è‡´ï¼šRelease=$RELEASE_VERSIONï¼Œpackage.json=$PACKAGE_VERSION"
            exit 1
          fi
          
          echo "âœ… ç‰ˆæœ¬æ ¡éªŒé€šè¿‡ï¼š$RELEASE_VERSION"
          echo "PACKAGE_VERSION=$RELEASE_VERSION" >> $GITHUB_OUTPUT

      - name: å®‰è£…ä¾èµ– & æ„å»º
        run: |
          set -eu
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile --prod=false || echo "âš  ä¾èµ–å®‰è£…å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶å®‰è£…" && pnpm install --prod=false
          else
            pnpm install --prod=false
          fi
          
          if pnpm run build --help >/dev/null 2>&1; then
            pnpm run build || echo "âš  æ„å»ºå¤±è´¥ï¼Œè·³è¿‡æ„å»ºç»§ç»­å‘å¸ƒ"
          else
            echo "âš  æ—  build è„šæœ¬"
          fi

      - name: é…ç½® npm è®¤è¯
        run: |
          set -eu
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "âŒ NPM_TOKEN æœªé…ç½®ï¼"
            exit 1
          fi
          
          NPM_REGISTRY_NO_PROTOCOL="${{ env.NPM_REGISTRY }}"
          NPM_REGISTRY_NO_PROTOCOL=${NPM_REGISTRY_NO_PROTOCOL#https://}
          
          echo "//${NPM_REGISTRY_NO_PROTOCOL}/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc
          echo "@${{ steps.dynamic_config.outputs.NPM_SCOPE }}:registry=${{ env.NPM_REGISTRY }}" >> .npmrc
          echo "cache=false" >> .npmrc
          echo "always-auth=true" >> .npmrc
          
          echo "ğŸ“„ .npmrc é…ç½®ï¼š"
          cat .npmrc
          npm config list || true

      - name: å‘å¸ƒ NPM åŒ…
        run: |
          set -eu
          # å®šä¹‰å˜é‡å¹¶å…œåº•ï¼Œé¿å… undefined
          PACKAGE_NAME="${{ steps.dynamic_config.outputs.PACKAGE_NAME }}"
          PACKAGE_VERSION="${{ steps.version_check.outputs.PACKAGE_VERSION }}"
          NPM_REGISTRY="${{ env.NPM_REGISTRY }}"
          
          PACKAGE_NAME=${PACKAGE_NAME:-"@wangchen2021/chen-rsbuild-cli"}
          PACKAGE_VERSION=${PACKAGE_VERSION:-"0.0.5"}
          NPM_REGISTRY=${NPM_REGISTRY:-"https://npm.pkg.github.com"}
          
          echo "ğŸ“¤ å‡†å¤‡å‘å¸ƒï¼š$PACKAGE_NAME@$PACKAGE_VERSION åˆ° $NPM_REGISTRY"
          
          # æ ¸å¿ƒï¼šç”¨ || æ•è·é”™è¯¯ï¼Œæ‰“å°è¯¦ç»†ä¿¡æ¯
          if [ "$NPM_REGISTRY" = "https://registry.npmjs.org" ]; then
            npm publish --access public --verbose 2>&1 || {
              echo "âŒ npm å‘å¸ƒå¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯ï¼š$?"
              exit 1
            }
          else
            # GitHub Packages å‘å¸ƒï¼Œå¼ºåˆ¶æŒ‡å®š registry
            npm publish --registry="$NPM_REGISTRY" --userconfig .npmrc --verbose 2>&1 || {
              echo "âŒ npm å‘å¸ƒå¤±è´¥ï¼Œé”™è¯¯ç ï¼š$?"
              # æ‰“å°æ‰€æœ‰å¯èƒ½çš„é”™è¯¯ä¿¡æ¯
              npm config get registry
              npm whoami --registry="$NPM_REGISTRY" || echo "âŒ npm whoami å¤±è´¥ï¼ˆè®¤è¯é—®é¢˜ï¼‰"
              exit 1
            }
          fi
          
          echo "âœ… å‘å¸ƒæˆåŠŸï¼"

      - name: è¾“å‡ºå‘å¸ƒä¿¡æ¯
        if: always()
        run: |
          echo "ğŸ“¦ å‘å¸ƒæ±‡æ€»ï¼š"
          echo "========================================"
          echo "åŒ…åï¼š${{ steps.dynamic_config.outputs.PACKAGE_NAME }}"
          echo "ç‰ˆæœ¬ï¼š${{ steps.version_check.outputs.PACKAGE_VERSION }}"
          echo "ä»“åº“ï¼š${{ env.NPM_REGISTRY }}"
          echo "çŠ¶æ€ï¼š${{ job.status }}"
          echo "æ—¶é—´ï¼š$(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S')"
          echo "========================================"
          # è°ƒè¯•å…³é”®ä¿¡æ¯
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯ï¼š"
          echo "github.repository_owner: ${{ github.repository_owner }}"
          echo "github.ref_name: ${{ github.ref_name }}"
          echo "å½“å‰ç›®å½•æ–‡ä»¶ï¼š"
          ls -la
          echo "npm ç‰ˆæœ¬ï¼š$(npm -v)"
          echo "node ç‰ˆæœ¬ï¼š$(node -v)"
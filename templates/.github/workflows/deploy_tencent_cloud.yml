name: Frontend CI - Build & Push Docker Image
run-name: ${{ github.actor }} æ„å»ºå‰ç«¯é•œåƒ ğŸš€ [${{ github.ref_name }}]

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      deploy_env:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production

env:
  NODE_VERSION: '24.11.0'
  PNPM_VERSION: '10.20.0'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install base dependencies
        run: |
          sudo apt-get update -y && sudo apt-get install -y --no-install-recommends tar curl
          tar --version && curl --version

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: ''

      - name: Generate build info
        id: build_info
        run: |
          set -e
          # 1. åŸºç¡€ä¿¡æ¯è·å–ï¼ˆçº¯å­—ç¬¦ä¸²ï¼Œæ— ç‰¹æ®Šå­—ç¬¦ï¼‰
          COMMIT_HASH=$(git rev-parse --short HEAD)
          BRANCH_NAME=${{ github.ref_name }}
          DEPLOY_ENV=${{ github.event.inputs.deploy_env || 'production' }}
          
          # 2. æ—¶é—´æ ¼å¼åŒ–ï¼ˆæ‹†åˆ†å˜é‡ï¼Œé¿å…å¼•å·å†²çªï¼‰
          BUILD_TIME_STAMP=$(TZ=Asia/Shanghai date +"%Y%m%d%H%M%S") # çº¯æ•°å­—ï¼ˆæ— ç‰¹æ®Šå­—ç¬¦ï¼‰
          BUILD_TIME_FORMATTED=$(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S') # å¸¦ç‰¹æ®Šå­—ç¬¦
          
          # 3. ç”Ÿæˆé•œåƒæ ‡ç­¾ï¼ˆçº¯å­—ç¬¦ä¸²ï¼Œæ— ç‰¹æ®Šå­—ç¬¦ï¼‰
          IMAGE_TAG="${DEPLOY_ENV}-${BRANCH_NAME}-${BUILD_TIME_STAMP}-${COMMIT_HASH}"
          
          # 4. è¾“å‡ºåˆ°GitHubä¸Šä¸‹æ–‡ï¼ˆå…³é”®ï¼šç”¨printfè½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼‰
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "COMMIT_HASH=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          # ç”¨printfè½¬ä¹‰æ¢è¡Œ/ç©ºæ ¼ï¼Œé¿å…GitHubä¸Šä¸‹æ–‡è§£æé”™è¯¯
          printf "BUILD_TIME_FORMATTED=%q\n" "${BUILD_TIME_FORMATTED}" >> $GITHUB_OUTPUT

      - name: Install dependencies & Build (Rsbuild)
        run: |
          set -e
          pnpm install --frozen-lockfile --prod=false
          
          # å…³é”®ä¿®å¤ï¼šç”¨å•å¼•å·åŒ…è£¹å¸¦ç‰¹æ®Šå­—ç¬¦çš„å˜é‡å€¼ï¼Œé¿å…Shellè§£æé”™è¯¯
          # æ–¹å¼1ï¼šçº¯å­—ç¬¦ä¸²å˜é‡ï¼ˆæ— ç‰¹æ®Šå­—ç¬¦ï¼‰ç›´æ¥å¯¼å‡º
          export GIT_COMMIT_HASH="${{ steps.build_info.outputs.COMMIT_HASH }}"
          export GIT_TAG="${{ steps.build_info.outputs.IMAGE_TAG }}"
          export GIT_BRANCH="${{ steps.build_info.outputs.BRANCH_NAME }}"
          # æ–¹å¼2ï¼šå¸¦ç©ºæ ¼/å†’å·çš„å˜é‡ï¼Œç”¨å•å¼•å·å¼ºåˆ¶åŒ…è£¹ä¸ºæ•´ä½“
          export BUILD_TIME='${{ steps.build_info.outputs.BUILD_TIME_FORMATTED }}'
          
          # æ‰§è¡ŒRsbuildæ„å»ºï¼ˆç¯å¢ƒå˜é‡ä¼šè¢«Rsbuildæ­£ç¡®è¯»å–ï¼‰
          pnpm run build -- --verbose
          
          # æ ¡éªŒæ„å»ºäº§ç‰©
          if [ ! -f "./dist/index.html" ]; then
            echo "æ„å»ºå¤±è´¥ï¼šdist/index.htmlä¸å­˜åœ¨ï¼"
            exit 1
          fi

      - name: Set up Docker Buildx
        id: setup-buildx  # å…³é”®ï¼šæ·»åŠ id
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container
          driver-opts: |
            network=host

      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}

      - name: Build & Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_REPO }}:${{ steps.build_info.outputs.IMAGE_TAG }}
            ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_REPO }}:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_REPO }}:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_REPO }}:buildcache,mode=max
          build-args: |
            BUILD_TAG=${{ steps.build_info.outputs.IMAGE_TAG }}
            BUILD_ENV=${{ github.event.inputs.deploy_env || 'production' }}
            GIT_COMMIT_HASH=${{ steps.build_info.outputs.COMMIT_HASH }}
            GIT_TAG=${{ steps.build_info.outputs.IMAGE_TAG }}
            GIT_BRANCH=${{ steps.build_info.outputs.BRANCH_NAME }}
          builder: ${{ steps.setup-buildx.outputs.name }}  # ç°åœ¨èƒ½æ­£ç¡®å¼•ç”¨

      - name: Output image info
        run: |
          echo "âœ… é•œåƒæ¨é€å®Œæˆï¼"
          echo "é•œåƒåœ°å€ï¼š${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_REPO }}:${{ steps.build_info.outputs.IMAGE_TAG }}"
          echo "æäº¤å“ˆå¸Œï¼š${{ steps.build_info.outputs.COMMIT_HASH }}"
          echo "åˆ†æ”¯åç§°ï¼š${{ steps.build_info.outputs.BRANCH_NAME }}"
          echo "æ„å»ºæ—¶é—´ï¼š${{ steps.build_info.outputs.BUILD_TIME_FORMATTED }}"
name: NPM Publish - Auto Release
run-name: ${{ github.actor }} å‘å¸ƒ NPM åŒ… ğŸš€ [${{ github.ref_name }}]

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      deploy_env:
        description: 'å‘å¸ƒç¯å¢ƒï¼ˆä»…ç”¨äºæ ‡è¯†ï¼‰'
        required: true
        default: 'production'
        type: choice
        options:
          - production

env:
  NODE_VERSION: '24.11.0'
  PNPM_VERSION: '10.20.0'
  # å‘å¸ƒä»“åº“ï¼ˆé™æ€å€¼ï¼Œé¿å…è¡¨è¾¾å¼åµŒå¥—ï¼‰
  NPM_REGISTRY: 'https://npm.pkg.github.com'
  # ç§»é™¤ï¼šenv ä¸­ä¸èƒ½ç›´æ¥ç”¨è¡¨è¾¾å¼ï¼Œç§»åˆ° steps ä¸­å¤„ç†
  # NPM_SCOPE: ${{ github.repository_owner }} 
  # PACKAGE_NAME: ${{ github.event.repository.name }}

jobs:
  publish-npm-package:
    runs-on: ubuntu-latest
    # å…¨å±€é”™è¯¯æ•è·ï¼šå¤±è´¥æ—¶è¾“å‡ºè¯¦ç»†æ—¥å¿—
    env:
      SHELLOPTS: errexit:pipefail
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install base dependencies
        run: |
          sudo apt-get update -y && sudo apt-get install -y --no-install-recommends tar curl jq
          tar --version && curl --version && jq --version

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: ${{ env.NPM_REGISTRY }}

      - name: åˆå§‹åŒ–åŠ¨æ€é…ç½®ï¼ˆä¿®å¤è¡¨è¾¾å¼/å…¼å®¹æ€§é—®é¢˜ï¼‰
        id: dynamic_config
        run: |
          set -euo pipefail
          # 1. ä» GitHub ä¸Šä¸‹æ–‡è·å–ç”¨æˆ·å/ä»“åº“åï¼ˆä¿®å¤ env è¡¨è¾¾å¼é—®é¢˜ï¼‰
          NPM_SCOPE="${{ github.repository_owner }}"
          PACKAGE_NAME_BASE="${{ github.event.repository.name }}"
          
          # 2. å…¼å®¹è·å– package.json åŒ…åï¼ˆç”¨ jq æ›¿ä»£ pnpm pkg getï¼Œå…¼å®¹æ€§æ›´å¥½ï¼‰
          if [ -f "package.json" ]; then
            PACKAGE_NAME_FROM_JSON=$(jq -r '.name' package.json)
            # å¤„ç†ç©ºå€¼/undefined
            if [ "$PACKAGE_NAME_FROM_JSON" = "null" ] || [ -z "$PACKAGE_NAME_FROM_JSON" ]; then
              PACKAGE_NAME_FROM_JSON="@${NPM_SCOPE}/${PACKAGE_NAME_BASE}"
            fi
          else
            PACKAGE_NAME_FROM_JSON="@${NPM_SCOPE}/${PACKAGE_NAME_BASE}"
          fi
          
          # 3. æå–ä½œç”¨åŸŸï¼ˆå…¼å®¹æ— ä½œç”¨åŸŸçš„åŒ…åï¼‰
          if echo "$PACKAGE_NAME_FROM_JSON" | grep -q '/'; then
            NPM_SCOPE_CLEAN=$(echo "$PACKAGE_NAME_FROM_JSON" | cut -d'/' -f1 | sed 's/^@//')
          else
            NPM_SCOPE_CLEAN="$NPM_SCOPE"
          fi
          
          # 4. è¾“å‡ºåˆ° GitHub ä¸Šä¸‹æ–‡
          echo "PACKAGE_NAME=$PACKAGE_NAME_FROM_JSON" >> $GITHUB_OUTPUT
          echo "NPM_SCOPE=$NPM_SCOPE_CLEAN" >> $GITHUB_OUTPUT
          
          # éªŒè¯è¾“å‡º
          echo "âœ… åŠ¨æ€é…ç½®åˆå§‹åŒ–å®Œæˆï¼š"
          echo "åŒ…åï¼š$PACKAGE_NAME_FROM_JSON"
          echo "ä½œç”¨åŸŸï¼š$NPM_SCOPE_CLEAN"

      - name: éªŒè¯ Release ç‰ˆæœ¬ä¸ package.json ä¸€è‡´
        id: version_check
        run: |
          set -euo pipefail
          # è·å– Release æ ‡ç­¾ç‰ˆæœ¬ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
          RELEASE_VERSION="${{ github.ref_name }}"
          RELEASE_VERSION=${RELEASE_VERSION#v}
          
          # å…¼å®¹è·å– package.json ç‰ˆæœ¬ï¼ˆç”¨ jqï¼‰
          if [ -f "package.json" ]; then
            PACKAGE_VERSION=$(jq -r '.version' package.json)
            if [ "$PACKAGE_VERSION" = "null" ] || [ -z "$PACKAGE_VERSION" ]; then
              echo "âŒ package.json ä¸­æœªé…ç½® version å­—æ®µï¼"
              exit 1
            fi
          else
            echo "âŒ æœªæ‰¾åˆ° package.json æ–‡ä»¶ï¼"
            exit 1
          fi
          
          # ç‰ˆæœ¬æ ¡éªŒ
          if [ "$RELEASE_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "âŒ Release ç‰ˆæœ¬ï¼ˆ$RELEASE_VERSIONï¼‰ä¸ package.json ç‰ˆæœ¬ï¼ˆ$PACKAGE_VERSIONï¼‰ä¸ä¸€è‡´ï¼"
            exit 1
          fi
          
          echo "âœ… ç‰ˆæœ¬æ ¡éªŒé€šè¿‡ï¼š$RELEASE_VERSION"
          echo "PACKAGE_VERSION=$RELEASE_VERSION" >> $GITHUB_OUTPUT

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        run: |
          set -euo pipefail
          # æ£€æŸ¥ lock æ–‡ä»¶
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile --prod=false
          else
            pnpm install --prod=false
          fi
          
          # å¯é€‰ï¼šæ‰§è¡Œæ„å»ºï¼ˆå…¼å®¹ä¸åŒè„šæœ¬åï¼‰
          if pnpm run build --help >/dev/null 2>&1; then
            pnpm run build
          elif pnpm run compile --help >/dev/null 2>&1; then
            pnpm run compile
          else
            echo "âš  æ—  build/compile è„šæœ¬ï¼Œè·³è¿‡æ„å»º"
          fi

      - name: é…ç½® npm è®¤è¯ï¼ˆåŠ¨æ€ä½œç”¨åŸŸï¼‰
        run: |
          set -euo pipefail
          # æ£€æŸ¥ NPM_TOKEN æ˜¯å¦é…ç½®
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "âŒ æœªé…ç½® NPM_TOKEN å¯†é’¥ï¼"
            exit 1
          fi
          
          # å¤„ç† registry åœ°å€ï¼ˆå»æ‰ https:// å‰ç¼€ï¼‰
          NPM_REGISTRY_NO_PROTOCOL="${{ env.NPM_REGISTRY }}"
          NPM_REGISTRY_NO_PROTOCOL=${NPM_REGISTRY_NO_PROTOCOL#https://}
          
          # ç”Ÿæˆ .npmrcï¼ˆåŠ¨æ€ä½œç”¨åŸŸï¼‰
          echo "//${NPM_REGISTRY_NO_PROTOCOL}/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc
          echo "@${{ steps.dynamic_config.outputs.NPM_SCOPE }}:registry=${{ env.NPM_REGISTRY }}" >> .npmrc
          # è¡¥å……ï¼šç¦ç”¨ npm ç¼“å­˜ï¼Œé¿å…å†²çª
          echo "cache=false" >> .npmrc
          
          # éªŒè¯é…ç½®
          echo "ğŸ“„ ç”Ÿæˆçš„ .npmrc é…ç½®ï¼š"
          cat .npmrc

      - name: å‘å¸ƒ NPM åŒ…
        run: |
          set -euo pipefail
          # å‘å¸ƒå‰æ£€æŸ¥åŒ…å/ç‰ˆæœ¬
          echo "ğŸ“¤ å¼€å§‹å‘å¸ƒåŒ…ï¼š${{ steps.dynamic_config.outputs.PACKAGE_NAME }}@${{ steps.version_check.outputs.PACKAGE_VERSION }}"
          
          # æ ¹æ®ä»“åº“ç±»å‹é€‰æ‹©å‘å¸ƒå‚æ•°
          if [ "${{ env.NPM_REGISTRY }}" = "https://registry.npmjs.org" ]; then
            npm publish --access public
          else
            # GitHub Packages å‘å¸ƒï¼ˆå¼ºåˆ¶ä½¿ç”¨æœ¬åœ° .npmrcï¼‰
            npm publish --userconfig .npmrc
          fi
          
          # éªŒè¯å‘å¸ƒç»“æœï¼ˆå…¼å®¹ GitHub Packagesï¼‰
          echo "âœ… NPM åŒ…å‘å¸ƒæˆåŠŸï¼"
          echo "åŒ…åï¼š${{ steps.dynamic_config.outputs.PACKAGE_NAME }}"
          echo "ç‰ˆæœ¬ï¼š${{ steps.version_check.outputs.PACKAGE_VERSION }}"
          # GitHub Packages ç”¨ gh api éªŒè¯ï¼ˆæ›¿ä»£ npm viewï¼‰
          if [ "${{ env.NPM_REGISTRY }}" = "https://npm.pkg.github.com" ]; then
            gh api "/users/${{ steps.dynamic_config.outputs.NPM_SCOPE }}/packages/npm/${PACKAGE_NAME_BASE}/versions/${{ steps.version_check.outputs.PACKAGE_VERSION }}" || echo "â„¹ GitHub API éªŒè¯è·³è¿‡ï¼ˆéœ€ gh æƒé™ï¼‰"
          else
            npm view "${{ steps.dynamic_config.outputs.PACKAGE_NAME }}" version || echo "â„¹ npm å®˜æ–¹éªŒè¯è·³è¿‡"
          fi

      - name: è¾“å‡ºå‘å¸ƒä¿¡æ¯
        if: always() # å³ä½¿å¤±è´¥ä¹Ÿè¾“å‡ºä¿¡æ¯
        run: |
          echo "ğŸ“¦ æœ€ç»ˆå‘å¸ƒä¿¡æ¯ï¼š"
          echo "åŒ…åï¼š${{ steps.dynamic_config.outputs.PACKAGE_NAME }}"
          echo "ç‰ˆæœ¬ï¼š${{ steps.version_check.outputs.PACKAGE_VERSION }}"
          echo "å‘å¸ƒä»“åº“ï¼š${{ env.NPM_REGISTRY }}"
          echo "ä½œç”¨åŸŸï¼š@${{ steps.dynamic_config.outputs.NPM_SCOPE }}"
          echo "å‘å¸ƒæ—¶é—´ï¼š$(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S')"
          echo "Release æ ‡ç­¾ï¼š${{ github.ref_name }}"
          echo "æ‰§è¡ŒçŠ¶æ€ï¼š${{ job.status }}"
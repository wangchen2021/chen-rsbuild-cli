name: Enterprise NPM Publish
run-name: ${{ github.actor }} å‘å¸ƒåŒ… ğŸš€ [${{ github.ref_name }}]

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      deploy_env:
        description: 'å‘å¸ƒç¯å¢ƒæ ‡è¯†'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - development
      custom_tag:
        description: 'è‡ªå®šä¹‰ npm æ ‡ç­¾ï¼ˆé»˜è®¤ latest æµ‹è¯•ç‰ˆå¡« betaï¼‰'
        required: false
        default: 'latest'

env:
  NODE_VERSION: '24.11.0'
  PNPM_VERSION: '10.20.0'
  NPM_REGISTRY: 'https://npm.pkg.github.com'
  NPM_SCOPE: '@wangchen2021'
  PACKAGE_JSON_PATH: './package.json'
  PNPM_HOME: '/home/runner/.local/share/pnpm'
  # æ ¸å¿ƒä¿®å¤ï¼šæ˜¾å¼å®šä¹‰ä¸´æ—¶ .npmrc è·¯å¾„ï¼ˆä¸å†ä¾èµ–æœªçŸ¥ç¯å¢ƒå˜é‡ï¼‰
  TEMP_NPMRC_PATH: '/home/runner/work/_temp/.npmrc'

jobs:
  publish-package:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
      id-token: write

    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      # 2. ç¯å¢ƒé¢„æ£€
      - name: Environment pre-check
        run: |
          echo "ğŸ” æ‰§è¡Œç¯å¢ƒé¢„æ£€..."
          if [ ! -f "${{ env.PACKAGE_JSON_PATH }}" ]; then
            echo "âŒ æ ¸å¿ƒæ–‡ä»¶ç¼ºå¤±ï¼š${{ env.PACKAGE_JSON_PATH }}"
            exit 1
          fi
          if [ -n "$(git status --porcelain)" ]; then
            echo "âš  å·¥ä½œåŒºå­˜åœ¨æœªæäº¤ä¿®æ”¹ï¼Œè¯·æ³¨æ„å®¡è®¡"
            git status --porcelain
          fi

      # 3. å®‰è£… pnpm å¹¶é…ç½®è·¯å¾„
      - name: Install pnpm ${{ env.PNPM_VERSION }}
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false
        env:
          PNPM_HOME: ${{ env.PNPM_HOME }}

      # 4. å°† pnpm åŠ å…¥ PATH
      - name: Add pnpm to PATH
        run: |
          echo "${{ env.PNPM_HOME }}" >> $GITHUB_PATH
          echo "PNPM_HOME=${{ env.PNPM_HOME }}" >> $GITHUB_ENV
          pnpm --version || {
            echo "âŒ pnpm å®‰è£…å¤±è´¥ï¼Œè·¯å¾„ï¼š${{ env.PNPM_HOME }}"
            exit 1
          }

      # 5. é…ç½® Node.js ç¯å¢ƒï¼ˆç¦ç”¨è‡ªåŠ¨ Token æ³¨å…¥ï¼‰
      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: './pnpm-lock.yaml'
          registry-url: ${{ env.NPM_REGISTRY }}
        env:
          NODE_AUTH_TOKEN: ""

      # 6. å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆé”å®šç‰ˆæœ¬ï¼‰..."
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile --prod=false --config.ignore-engines=true
          else
            echo "âŒ ç¼ºå¤± pnpm-lock.yamlï¼Œä¼ä¸šçº§é¡¹ç›®å¿…é¡»é”å®šä¾èµ–ç‰ˆæœ¬"
            exit 1
          fi
          pnpm audit --severity high || echo "âš  æ£€æµ‹åˆ°é«˜å±ä¾èµ–æ¼æ´ï¼Œè¯·åŠæ—¶ä¿®å¤"

      # 7. æ„å»ºé¡¹ç›®ï¼ˆä¿®å¤ TS ç¼–è¯‘å‚æ•°ï¼‰
      - name: Build project
        id: build
        run: |
          echo "ğŸ”¨ æ‰§è¡Œé¡¹ç›®æ„å»º..."
          if [ -f "package.json" ]; then
            sed -i 's/tsc --verbose/tsc/g' package.json
            echo "âœ… ä¿®å¤åçš„ build è„šæœ¬ï¼š$(pnpm pkg get scripts.build | tr -d '"')"
          fi

          if pnpm run build --help >/dev/null 2>&1; then
            pnpm run build --verbose 2>&1 || {
              echo "âŒ æ„å»ºå¤±è´¥ï¼Œå°è¯•ç›´æ¥æ‰§è¡Œ tsc"
              tsc
            }
            if [ ! -d "dist" ]; then
              echo "âŒ æ„å»ºäº§ç‰©ç›®å½• dist ç¼ºå¤±"
              exit 1
            fi
            echo "âœ… æ„å»ºæˆåŠŸï¼Œäº§ç‰©å¤§å°ï¼š$(du -sh dist | awk '{print $1}')"
            echo "build_success=true" >> $GITHUB_OUTPUT
          else
            echo "âš  æ—  build è„šæœ¬ï¼Œè·³è¿‡æ„å»º"
            echo "build_success=false" >> $GITHUB_OUTPUT
          fi

      # 8. ç‰ˆæœ¬ä¸€è‡´æ€§æ ¡éªŒ
      - name: Validate version consistency
        id: version_check
        run: |
          echo "ğŸ“Š æ ¡éªŒç‰ˆæœ¬ä¸€è‡´æ€§..."
          RELEASE_VERSION="${{ github.ref_name }}"
          RELEASE_VERSION_CLEAN=${RELEASE_VERSION#v}
          PACKAGE_VERSION=$(node -p "require('${{ env.PACKAGE_JSON_PATH }}').version")
          PACKAGE_VERSION=${PACKAGE_VERSION:-"0.0.0"}
          
          echo "ğŸ“ ç‰ˆæœ¬å¯¹æ¯”ï¼š"
          echo "Release ç‰ˆæœ¬ï¼ˆæ¸…ç†åï¼‰ï¼š$RELEASE_VERSION_CLEAN"
          echo "Package.json ç‰ˆæœ¬ï¼š$PACKAGE_VERSION"
          
          if [ "$RELEASE_VERSION_CLEAN" != "$PACKAGE_VERSION" ]; then
            echo "âŒ ç‰ˆæœ¬ä¸ä¸€è‡´ï¼šRelease($RELEASE_VERSION_CLEAN) â‰  Package($PACKAGE_VERSION)"
            exit 1
          fi
          
          echo "âœ… ç‰ˆæœ¬æ ¡éªŒé€šè¿‡ï¼š$PACKAGE_VERSION"
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT

      # 9. é…ç½® npm è®¤è¯ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šç§»é™¤æœªçŸ¥ç¯å¢ƒå˜é‡ï¼‰
      - name: Configure npm authentication
        run: |
          echo "ğŸ” é…ç½® npm è®¤è¯..."
          # ä¿®å¤ç‚¹1ï¼šä½¿ç”¨æ˜¾å¼å®šä¹‰çš„è·¯å¾„ï¼Œåˆ é™¤ä¸´æ—¶ .npmrcï¼ˆä¸å­˜åœ¨åˆ™å¿½ç•¥ï¼‰
          rm -f "${{ env.TEMP_NPMRC_PATH }}" || true
          
          # ä¿®å¤ç‚¹2ï¼šå•è¡Œ echo ç”Ÿæˆ .npmrcï¼Œé¿å… YAML æ ¼å¼é”™è¯¯
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc
          echo "@wangchen2021:registry=https://npm.pkg.github.com" >> .npmrc
          echo "always-auth=true" >> .npmrc
          echo "cache=false" >> .npmrc
          echo "//registry.npmjs.org/:_authToken=" >> .npmrc
          
          # å¼ºåˆ¶æŒ‡å®š npm ä½¿ç”¨å½“å‰ .npmrc
          npm config set userconfig "$(pwd)/.npmrc"
          npm config set registry "https://npm.pkg.github.com"
          
          # æ‰“å°é…ç½®ç”¨äºè°ƒè¯•
          echo "ğŸ“„ ç”Ÿæ•ˆçš„ .npmrc é…ç½®ï¼ˆè„±æ•ï¼‰ï¼š"
          cat .npmrc | sed "s/_authToken=.*/_authToken=***REDACTED***/"
          
          # éªŒè¯è®¤è¯
          echo "ğŸ” éªŒè¯ npm è®¤è¯..."
          npm whoami --registry="https://npm.pkg.github.com" --userconfig "$(pwd)/.npmrc" 2>&1 || {
            echo "âŒ npm è®¤è¯å¤±è´¥ï¼Œè¯¦ç»†æ’æŸ¥ä¿¡æ¯ï¼š"
            echo "1. å½“å‰ç›®å½•ï¼š$(pwd)"
            echo "2. .npmrc æƒé™ï¼š$(ls -la .npmrc)"
            echo "3. Token æƒé™éªŒè¯ï¼š"
            curl -s -H "Authorization: token ${{ secrets.NPM_TOKEN }}" https://api.github.com/user/packages || echo "Token æ—  packages æƒé™"
            exit 1
          }

      # 10. å‘å¸ƒåŒ…ï¼ˆpnpm publishï¼‰
      - name: Publish package with pnpm
        id: publish
        run: |
          echo "ğŸš€ å¼€å§‹å‘å¸ƒåŒ…ï¼š${{ env.NPM_SCOPE }}/chen-rsbuild-cli@${{ steps.version_check.outputs.package_version }}"
          CUSTOM_TAG="${{ github.event.inputs.custom_tag || 'beta' }}"
          
          pnpm publish \
            --registry="${{ env.NPM_REGISTRY }}" \
            --tag="$CUSTOM_TAG" \
            --access restricted \
            --config.ignore-engines=true \
            --userconfig "$(pwd)/.npmrc" \
            --verbose 2>&1 || {
              echo "âŒ pnpm å‘å¸ƒå¤±è´¥ï¼Œé”™è¯¯æ—¥å¿—ï¼š"
              cat ~/.npm/_logs/*-debug.log 2>/dev/null
              exit 1
            }
          
          echo "âœ… åŒ…å‘å¸ƒæˆåŠŸï¼Œæ ‡ç­¾ï¼š$CUSTOM_TAG"
          echo "publish_tag=$CUSTOM_TAG" >> $GITHUB_OUTPUT

      # 11. å‘å¸ƒåå®¡è®¡
      - name: Post-publish audit
        if: always()
        run: |
          echo "ğŸ“‹ å‘å¸ƒå®¡è®¡æŠ¥å‘Š..."
          echo "========================================"
          echo "ä¼ä¸šçº§å‘å¸ƒå®¡è®¡ä¿¡æ¯ï¼š"
          echo "å‘å¸ƒæ—¶é—´ï¼š$(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S')"
          echo "å‘å¸ƒäººï¼š${{ github.actor }}"
          echo "åŒ…åï¼š$(node -p "require('${{ env.PACKAGE_JSON_PATH }}').name")"
          echo "ç‰ˆæœ¬ï¼š${{ steps.version_check.outputs.package_version }}"
          echo "å‘å¸ƒä»“åº“ï¼š${{ env.NPM_REGISTRY }}"
          echo "å‘å¸ƒæ ‡ç­¾ï¼š${{ steps.publish.outputs.publish_tag }}"
          echo "æ„å»ºçŠ¶æ€ï¼š${{ steps.build.outputs.build_success }}"
          echo "Node ç‰ˆæœ¬ï¼š$(node -v)"
          echo "pnpm ç‰ˆæœ¬ï¼š$(pnpm --version)"
          echo "GitHub Releaseï¼šhttps://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          echo "========================================"

      # 12. å¤±è´¥é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Send failure notification
        if: failure()
        run: |
          echo "ğŸš¨ åŒ…å‘å¸ƒå¤±è´¥ï¼Œè¯·åŠæ—¶å¤„ç†ï¼"